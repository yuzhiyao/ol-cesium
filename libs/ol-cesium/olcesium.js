var olcs_unused_var=function(e){var t={};function i(n){if(t[n])return t[n].exports;var s=t[n]={i:n,l:!1,exports:{}};return e[n].call(s.exports,s,s.exports,i),s.l=!0,s.exports}return i.m=e,i.c=t,i.d=function(e,t,n){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(i.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)i.d(n,s,function(t){return e[t]}.bind(null,s));return n},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i(i.s=23)}([function(e,t){e.exports=ol.proj},function(e,t){e.exports=ol.Observable},function(e,t){e.exports=ol.layer.Group},function(e,t){e.exports=ol.source.Vector},function(e,t){e.exports=ol.layer.Image},function(e,t){e.exports=ol.source.Cluster},function(e,t){e.exports=ol.layer.Vector},function(e,t){e.exports=ol.geom.Geometry},function(e,t){e.exports=ol.style.Icon},function(e,t){e.exports=ol.extent},function(e,t){e.exports=ol.geom.Point},function(e,t){e.exports=ol.easing},function(e,t){e.exports=ol.layer.Tile},function(e,t){e.exports=ol.source.ImageStatic},function(e,t){e.exports=ol.source.ImageWMS},function(e,t){e.exports=ol.source.TileImage},function(e,t){e.exports=ol.source.TileWMS},function(e,t){e.exports=ol.source.Image},function(e,t){e.exports=ol.layer.Layer},function(e,t){e.exports=ol.layer.VectorTile},function(e,t){e.exports=ol.geom.Polygon},function(e,t){e.exports=ol.geom.SimpleGeometry},function(e,t){e.exports=ol.Overlay},function(e,t,i){"use strict";i.r(t);i(10);var n=i(0);const s={};function r(e,t,i){return e.on(t,i)}s.obj=function(e){return e},s.supportsImageRenderingPixelatedResult_=void 0,s.imageRenderingValueResult_=void 0,s.supportsImageRenderingPixelated=function(){if(void 0===s.supportsImageRenderingPixelatedResult_){const e=document.createElement("canvas");e.setAttribute("style","image-rendering: -moz-crisp-edges; image-rendering: pixelated;");const t=e.style.imageRendering;s.supportsImageRenderingPixelatedResult_=!!t,s.supportsImageRenderingPixelatedResult_&&(s.imageRenderingValueResult_=t)}return s.supportsImageRenderingPixelatedResult_},s.imageRenderingValue=function(){return s.supportsImageRenderingPixelated(),s.imageRenderingValueResult_||""},s.getSourceProjection=function(e){return e.get("olcs.projection")||e.getProjection()};let o=0;function a(e){return e.olcs_uid||(e.olcs_uid=++o)}function l(e){const t=Cesium.GroundPolylinePrimitive;return t&&t.isSupported(e)}var c=s,u=i(11),h=i(12),m=i.n(h),d=i(4),g=i.n(d),p=i(13),C=i.n(p),y=i(14),_=i.n(y),f=i(15),v=i.n(f),w=i(16),S=i.n(w),b=i(17);class T{constructor(e,t,i){this.source_=t,this.projection_=null,this.fallbackProj_=i||null,this.ready_=!1,this.tilingScheme_=null,this.rectangle_=null,this.map_=e;const n=this.source_.get("olcs.proxy");n&&("function"==typeof n?this.proxy_={getURL:n}:"string"==typeof n&&(this.proxy_=new Cesium.DefaultProxy(n))),this.errorEvent_=new Cesium.Event,this.emptyCanvas_=document.createElement("canvas"),this.emptyCanvas_.width=1,this.emptyCanvas_.height=1,this.source_.on("change",e=>{this.handleSourceChanged_()}),this.handleSourceChanged_()}handleSourceChanged_(e){if(!this.ready_&&"ready"==this.source_.getState()){if(this.projection_=c.getSourceProjection(this.source_)||this.fallbackProj_,this.projection_==Object(n.get)("EPSG:4326"))this.tilingScheme_=new Cesium.GeographicTilingScheme;else{if(this.projection_!=Object(n.get)("EPSG:3857"))return;this.tilingScheme_=new Cesium.WebMercatorTilingScheme}this.rectangle_=this.tilingScheme_.rectangle,this.ready_=!0}}getTileCredits(e,t,i){const n=this.map_.getView().calculateExtent(this.map_.getSize()),s=this.map_.getView().getCenter(),r={viewState:{zoom:this.tilingScheme_ instanceof Cesium.GeographicTilingScheme?i+1:i,center:s},extent:n},o=this.source_.getAttributions();if(!o)return[];let a=o(r);return Array.isArray(a)||(a=[a]),a.map(e=>new Cesium.Credit(e,!0))}requestImage(e,t,i){const n=this.source_.getTileUrlFunction();if(n&&this.projection_){const s=this.tilingScheme_ instanceof Cesium.GeographicTilingScheme?i+1:i,r=-t-1;let o=n.call(this.source_,[s,e,r],1,this.projection_);return this.proxy_&&(o=this.proxy_.getURL(o)),o?Cesium.ImageryProvider.loadImage(this,o):this.emptyCanvas_}return this.emptyCanvas_}}Object.defineProperties(T.prototype,{ready:{get:function(){return this.ready_}},rectangle:{get:function(){return this.rectangle_}},tileWidth:{get:function(){const e=this.source_.getTileGrid();return e?Array.isArray(e.getTileSize(0))?e.getTileSize(0)[0]:e.getTileSize(0):256}},tileHeight:{get:function(){const e=this.source_.getTileGrid();return e?Array.isArray(e.getTileSize(0))?e.getTileSize(0)[1]:e.getTileSize(0):256}},maximumLevel:{get:function(){const e=this.source_.getTileGrid();return e?e.getMaxZoom():18}},minimumLevel:{get:function(){return 0}},tilingScheme:{get:function(){return this.tilingScheme_}},tileDiscardPolicy:{get:function(){}},errorEvent:{get:function(){return this.errorEvent_}},proxy:{get:function(){return this.proxy_}},hasAlphaChannel:{get:function(){return!0}},pickFeatures:{get:function(){}}});var L=T;const P={computePixelSizeAtCoordinate:function(e,t){const i=e.camera,n=e.canvas,s=i.frustum,r=Cesium.Cartesian3.magnitude(Cesium.Cartesian3.subtract(i.position,t,new Cesium.Cartesian3)),o=new Cesium.Cartesian2;return s.getPixelDimensions(n.clientWidth,n.clientHeight,r,o)},computeBoundingBoxAtTarget:function(e,t,i){const n=P.computePixelSizeAtCoordinate(e,t),s=Cesium.Transforms.eastNorthUpToFixedFrame(t),r=Cesium.Matrix4.multiplyByPoint(s,new Cesium.Cartesian3(-n.x*i,-n.y*i,0),new Cesium.Cartesian3),o=Cesium.Matrix4.multiplyByPoint(s,new Cesium.Cartesian3(n.x*i,n.y*i,0),new Cesium.Cartesian3);return Cesium.Ellipsoid.WGS84.cartesianArrayToCartographicArray([r,o])},applyHeightOffsetToGeometry:function(e,t){e.applyTransform((e,i,n)=>{if(void 0!==n&&n>=3)for(let e=0;e<i.length;e+=n)i[e+2]=i[e+2]+t;return i})},createMatrixAtCoordinates:function(e,t=0,i=Cesium.Cartesian3.ZERO,n=new Cesium.Cartesian3(1,1,1)){const s=P.ol4326CoordinateToCesiumCartesian(e),r=Cesium.Transforms.eastNorthUpToFixedFrame(s),o=Cesium.Quaternion.fromAxisAngle(Cesium.Cartesian3.UNIT_Z,-t),a=Cesium.Matrix4.fromTranslationQuaternionRotationScale(i,o,n);return Cesium.Matrix4.multiply(r,a,new Cesium.Matrix4)},rotateAroundAxis:function(e,t,i,n,s){const r=Cesium.Math.clamp,o=Cesium.defaultValue,a=s||{},l=o(a.duration,500),c=o(a.easing,u.linear),h=a.callback;let m=0;const d=new Cesium.Matrix4,g=Date.now(),p=function(){const s=Date.now(),o=c(r((s-g)/l,0,1));e.transform.clone(d);const a=(o-m)*t;m=o,e.lookAtTransform(n),e.rotate(i,a),e.lookAtTransform(d),o<1?window.requestAnimationFrame(p):h&&h()};window.requestAnimationFrame(p)},setHeadingUsingBottomCenter:function(e,t,i,n){const s=e.camera,r=P.computeAngleToZenith(e,i),o=s.right,a=Cesium.Quaternion.fromAxisAngle(o,r),l=Cesium.Matrix3.fromQuaternion(a),c=new Cesium.Cartesian3;Cesium.Cartesian3.subtract(s.position,i,c);const u=new Cesium.Cartesian3;Cesium.Matrix3.multiplyByVector(l,c,u),Cesium.Cartesian3.add(u,i,u);const h=Cesium.Matrix4.fromTranslation(u);(0,P.rotateAroundAxis)(s,t,u,h,n)},pickOnTerrainOrEllipsoid:function(e,t){const i=e.camera.getPickRay(t);return e.globe.pick(i,e)||e.camera.pickEllipsoid(t)},pickBottomPoint:function(e){const t=e.canvas,i=new Cesium.Cartesian2(t.clientWidth/2,t.clientHeight);return P.pickOnTerrainOrEllipsoid(e,i)},pickCenterPoint:function(e){const t=e.canvas,i=new Cesium.Cartesian2(t.clientWidth/2,t.clientHeight/2);return P.pickOnTerrainOrEllipsoid(e,i)},computeSignedTiltAngleOnGlobe:function(e){const t=e.camera,i=new Cesium.Ray(t.position,t.direction);let n=e.globe.pick(i,e);if(!n){const e=Cesium.Ellipsoid.WGS84,t=Cesium.IntersectionTests.rayEllipsoid(i,e);t&&(n=Cesium.Ray.getPoint(i,t.start))}if(!n)return;const s=new Cesium.Cartesian3;Cesium.Ellipsoid.WGS84.geocentricSurfaceNormal(n,s);const r=(0,P.signedAngleBetween)(t.direction,s,t.right)-Math.PI;return Cesium.Math.convertLongitudeRange(r)},bottomFovRay:function(e){const t=e.camera,i=t.frustum.fovy/2,n=t.direction,s=Cesium.Quaternion.fromAxisAngle(t.right,i),r=Cesium.Matrix3.fromQuaternion(s),o=new Cesium.Cartesian3;return Cesium.Matrix3.multiplyByVector(r,n,o),new Cesium.Ray(t.position,o)},signedAngleBetween:function(e,t,i){const n=new Cesium.Cartesian3,s=new Cesium.Cartesian3,r=new Cesium.Cartesian3;Cesium.Cartesian3.normalize(e,n),Cesium.Cartesian3.normalize(t,s),Cesium.Cartesian3.cross(n,s,r);const o=Cesium.Cartesian3.dot(n,s),a=Cesium.Cartesian3.magnitude(r),l=Cesium.Cartesian3.dot(i,r),c=Math.atan2(a,o);return l>=0?c:-c},computeAngleToZenith:function(e,t){const i=e.camera,n=i.frustum.fovy/2,s=P.bottomFovRay(e),r=Cesium.Cartesian3.clone(s.direction);Cesium.Cartesian3.negate(r,r);const o=new Cesium.Cartesian3;Cesium.Ellipsoid.WGS84.geocentricSurfaceNormal(t,o);const a=new Cesium.Cartesian3;return Cesium.Cartesian3.negate(i.right,a),P.signedAngleBetween(o,r,a)+n},extentToRectangle:function(e,t){if(e&&t){const i=Object(n.transformExtent)(e,t,"EPSG:4326");return Cesium.Rectangle.fromDegrees(i[0],i[1],i[2],i[3])}return null},tileLayerToImageryLayer:function(e,t,i){if(!(t instanceof m.a||t instanceof g.a))return null;let n=null,s=t.getSource();if(s instanceof _.a&&s.getUrl()&&s.getImageLoadFunction()===b.defaultImageLoadFunction){const e={"olcs.proxy":s.get("olcs.proxy"),"olcs.extent":s.get("olcs.extent"),"olcs.projection":s.get("olcs.projection"),"olcs.imagesource":s};(s=new S.a({url:s.getUrl(),attributions:s.getAttributions(),projection:s.getProjection(),params:s.getParams()})).setProperties(e)}if(s instanceof v.a){let t=c.getSourceProjection(s);if(t||(t=i),!P.isCesiumProjection(t))return null;n=new L(e,s,i)}else{if(!(s instanceof C.a))return null;{let e=c.getSourceProjection(s);if(e||(e=i),!P.isCesiumProjection(e))return null;n=new Cesium.SingleTileImageryProvider({url:s.getUrl(),rectangle:new Cesium.Rectangle.fromDegrees(s.getImageExtent()[0],s.getImageExtent()[1],s.getImageExtent()[2],s.getImageExtent()[3])})}}const r={},o=t.get("olcs.extent")||t.getExtent();return o&&(r.rectangle=P.extentToRectangle(o,i)),new Cesium.ImageryLayer(n,r)},updateCesiumLayerProperties:function(e,t){let i=1,n=!0;[e.layer].concat(e.parents).forEach(e=>{const t=e.getOpacity();void 0!==t&&(i*=t);const s=e.getVisible();void 0!==s&&(n&=s)}),t.alpha=i,t.show=n},ol4326CoordinateToCesiumCartesian:function(e){const t=e;return t.length>2?Cesium.Cartesian3.fromDegrees(t[0],t[1],t[2]):Cesium.Cartesian3.fromDegrees(t[0],t[1])},ol4326CoordinateArrayToCsCartesians:function(e){const t=P.ol4326CoordinateToCesiumCartesian,i=[];for(let n=0;n<e.length;++n)i.push(t(e[n]));return i},olGeometryCloneTo4326:function(e,t){const i=Object(n.get)("EPSG:4326"),s=Object(n.get)(t);if(s!==i){const t=e.getProperties();(e=e.clone()).transform(s,i),e.setProperties(t)}return e},convertColorToCesium:function(e){if(e=e||"black",Array.isArray(e))return new Cesium.Color(Cesium.Color.byteToFloat(e[0]),Cesium.Color.byteToFloat(e[1]),Cesium.Color.byteToFloat(e[2]),e[3]);if("string"==typeof e)return Cesium.Color.fromCssColorString(e);if(e instanceof CanvasPattern||e instanceof CanvasGradient){const t=document.createElement("canvas"),i=t.getContext("2d");return t.width=t.height=256,i.fillStyle=e,i.fillRect(0,0,t.width,t.height),new Cesium.ImageMaterialProperty({image:t})}},convertUrlToCesium:function(e){let t="";const i=/\{(\d|[a-z])-(\d|[a-z])\}/,n=i.exec(e);if(n){e=e.replace(i,"{s}");const s=n[1].charCodeAt(0),r=n[2].charCodeAt(0);let o;for(o=s;o<=r;++o)t+=String.fromCharCode(o)}return{url:e,subdomains:t}},resetToNorthZenith:function(e,t){return new Promise((i,n)=>{const s=t.camera,r=P.pickBottomPoint(t);if(!r)return void n("Could not get bottom pivot");const o=e.getView().getRotation();if(void 0===o)return void n("The view is not initialized");const a=P.computeAngleToZenith(t,r);P.setHeadingUsingBottomCenter(t,o,r);const l=Cesium.Matrix4.fromTranslation(r),c=s.right,u={callback:()=>{const t=e.getView();P.normalizeView(t),i()}};P.rotateAroundAxis(s,-a,c,l,u)})},rotateAroundBottomCenter:function(e,t){return new Promise((i,n)=>{const s=e.camera,r=P.pickBottomPoint(e);if(!r)return void n("could not get bottom pivot");const o={callback:i},a=Cesium.Matrix4.fromTranslation(r),l=s.right;(0,P.rotateAroundAxis)(s,-t,l,a,o)})},normalizeView:function(e,t=0){const i=e.getResolution();e.setRotation(t),e.setResolution(e.constrainResolution(i))},isCesiumProjection:function(e){const t=e===Object(n.get)("EPSG:3857"),i=e===Object(n.get)("EPSG:4326");return t||i}};var R=P;var E=class{constructor(e){this.ol3d=e,this.scene_=e.getCesiumScene(),this.canvas_=this.scene_.canvas,this._boundNotifyRepaintRequired=this.notifyRepaintRequired.bind(this),this.repaintEventNames_=["mousemove","mousedown","mouseup","touchstart","touchend","touchmove","pointerdown","pointerup","pointermove","wheel"],this.enable()}enable(){this.scene_.requestRenderMode=!0,this.scene_.maximumRenderTimeChange=1e3;for(const e of this.repaintEventNames_)this.canvas_.addEventListener(e,this._boundNotifyRepaintRequired,!1);window.addEventListener("resize",this._boundNotifyRepaintRequired,!1),this.ol3d.getOlMap().getLayerGroup().on("change",this._boundNotifyRepaintRequired)}disable(){for(const e of this.repaintEventNames_)this.canvas_.removeEventListener(e,this._boundNotifyRepaintRequired,!1);window.removeEventListener("resize",this._boundNotifyRepaintRequired,!1),this.ol3d.getOlMap().getLayerGroup().un("change",this._boundNotifyRepaintRequired),this.scene_.requestRenderMode=!1}restartRenderLoop(){this.notifyRepaintRequired()}notifyRepaintRequired(){this.scene_.requestRender()}},O=i(1),x=i.n(O);function A(e){return 180*e/Math.PI}function G(e){return e*Math.PI/180}class I{constructor(e,t){this.scene_=e,this.cam_=e.camera,this.map_=t,this.view_=null,this.viewListenKey_=null,this.toLonLat_=I.identityProjection,this.fromLonLat_=I.identityProjection,this.tilt_=0,this.distance_=0,this.lastCameraViewMatrix_=null,this.viewUpdateInProgress_=!1,this.map_.on("change:view",e=>{this.setView_(this.map_.getView())}),this.setView_(this.map_.getView())}static identityProjection(e,t,i){const n=i||e.length;if(t)for(let i=0;i<n;++i)t[i]=e[i];return e}setView_(e){if(this.view_&&(Object(O.unByKey)(this.viewListenKey_),this.viewListenKey_=null),this.view_=e,e){const t=Object(n.getTransform)(e.getProjection(),"EPSG:4326"),i=Object(n.getTransform)("EPSG:4326",e.getProjection());this.toLonLat_=t,this.fromLonLat_=i,this.viewListenKey_=e.on("propertychange",e=>this.handleViewEvent_(e)),this.readFromView()}else this.toLonLat_=I.identityProjection,this.fromLonLat_=I.identityProjection}handleViewEvent_(e){this.viewUpdateInProgress_||this.readFromView()}setHeading(e){this.view_&&this.view_.setRotation(e)}getHeading(){if(!this.view_)return;return this.view_.getRotation()||0}setTilt(e){this.tilt_=e,this.updateCamera_()}getTilt(){return this.tilt_}setDistance(e){this.distance_=e,this.updateCamera_(),this.updateView()}getDistance(){return this.distance_}setCenter(e){this.view_&&this.view_.setCenter(e)}getCenter(){if(this.view_)return this.view_.getCenter()}setPosition(e){if(!this.toLonLat_)return;const t=this.toLonLat_(e),i=new Cesium.Cartographic(G(t[0]),G(t[1]),this.getAltitude());this.cam_.setView({destination:Cesium.Ellipsoid.WGS84.cartographicToCartesian(i)}),this.updateView()}getPosition(){if(!this.fromLonLat_)return;const e=Cesium.Ellipsoid.WGS84.cartesianToCartographic(this.cam_.position);return this.fromLonLat_([A(e.longitude),A(e.latitude)])}setAltitude(e){const t=Cesium.Ellipsoid.WGS84.cartesianToCartographic(this.cam_.position);t.height=e,this.cam_.position=Cesium.Ellipsoid.WGS84.cartographicToCartesian(t),this.updateView()}getAltitude(){return Cesium.Ellipsoid.WGS84.cartesianToCartographic(this.cam_.position).height}updateCamera_(){if(!this.view_||!this.toLonLat_)return;const e=this.view_.getCenter();if(!e)return;const t=this.toLonLat_(e),i=new Cesium.Cartographic(G(t[0]),G(t[1]));if(this.scene_.globe){const e=this.scene_.globe.getHeight(i);i.height=e||0}const n=Cesium.Ellipsoid.WGS84.cartographicToCartesian(i),s={pitch:this.tilt_-Cesium.Math.PI_OVER_TWO,heading:-this.view_.getRotation(),roll:void 0};this.cam_.setView({destination:n,orientation:s}),this.cam_.moveBackward(this.distance_),this.checkCameraChange(!0)}readFromView(){if(!this.view_||!this.toLonLat_)return;const e=this.view_.getCenter();if(null==e)return;const t=this.toLonLat_(e),i=this.view_.getResolution();this.distance_=this.calcDistanceForResolution(i||0,G(t[1])),this.updateCamera_()}updateView(){if(!this.view_||!this.fromLonLat_)return;this.viewUpdateInProgress_=!0;const e=Cesium.Ellipsoid.WGS84,t=this.scene_,i=R.pickCenterPoint(t);let n=i;if(!n){const e=t.globe,i=this.cam_.positionCartographic.clone(),s=e.getHeight(i);i.height=s||0,n=Cesium.Ellipsoid.WGS84.cartographicToCartesian(i)}this.distance_=Cesium.Cartesian3.distance(n,this.cam_.position);const s=e.cartesianToCartographic(n);if(this.view_.setCenter(this.fromLonLat_([A(s.longitude),A(s.latitude)])),this.view_.setResolution(this.calcResolutionForDistance(this.distance_,s?s.latitude:0)),i){const t=this.cam_.position,n=new Cesium.Cartesian3;e.geocentricSurfaceNormal(i,n);const s=new Cesium.Cartesian3;Cesium.Cartesian3.subtract(t,i,s),Cesium.Cartesian3.normalize(s,s);const r=this.cam_.up,o=this.cam_.right,a=new Cesium.Cartesian3(-i.y,i.x,0),l=Cesium.Cartesian3.angleBetween(o,a),c=Cesium.Cartesian3.cross(i,r,new Cesium.Cartesian3).z;this.view_.setRotation(c<0?l:-l);const u=Math.acos(Cesium.Cartesian3.dot(n,s));this.tilt_=isNaN(u)?0:u}else this.view_.setRotation(this.cam_.heading),this.tilt_=-this.cam_.pitch+Math.PI/2;this.viewUpdateInProgress_=!1}checkCameraChange(e){const t=this.lastCameraViewMatrix_,i=this.cam_.viewMatrix;t&&Cesium.Matrix4.equalsEpsilon(t,i,1e-5)||(this.lastCameraViewMatrix_=i.clone(),!0!==e&&this.updateView())}calcDistanceForResolution(e,t){const i=this.scene_.canvas,n=this.cam_.frustum.fovy,s=this.view_.getProjection().getMetersPerUnit();return e*i.clientHeight*s*Math.cos(Math.abs(t))/2/Math.tan(n/2)}calcResolutionForDistance(e,t){const i=this.scene_.canvas,n=this.cam_.frustum.fovy,s=this.view_.getProjection().getMetersPerUnit();return 2*e*Math.tan(n/2)/s/Math.cos(Math.abs(t))/i.clientHeight}}var M=I,F=i(2),k=i.n(F);var V=class{constructor(e,t){this.map=e,this.view=e.getView(),this.scene=t,this.olLayers=e.getLayerGroup().getLayers(),this.mapLayerGroup=e.getLayerGroup(),this.layerMap={},this.olLayerListenKeys={},this.olGroupListenKeys_={}}synchronize(){this.destroyAll(),this.addLayers_(this.mapLayerGroup)}orderLayers(){}addLayers_(e){const t=[{layer:e,parents:[]}];for(;t.length>0;){const e=t.splice(0,1)[0],i=e.layer,n=a(i).toString();this.olLayerListenKeys[n]=[];let s=null;if(i instanceof k.a)this.listenForGroupChanges_(i),i!==this.mapLayerGroup&&(s=this.createSingleLayerCounterparts(e)),s||i.getLayers().forEach(n=>{if(n){const s={layer:n,parents:i===this.mapLayerGroup?[]:[e.layer].concat(e.parents)};t.push(s)}});else if(!(s=this.createSingleLayerCounterparts(e))){const t=n,i=e,s=e=>{const n=this.createSingleLayerCounterparts(i);n&&(i.layer.un("change",s),this.addCesiumObjects_(n,t,i.layer),this.orderLayers())};this.olLayerListenKeys[n].push(r(i.layer,"change",s))}s&&this.addCesiumObjects_(s,n,i)}this.orderLayers()}addCesiumObjects_(e,t,i){this.layerMap[t]=e,this.olLayerListenKeys[t].push(r(i,"change:zIndex",()=>this.orderLayers())),e.forEach(e=>{this.addCesiumObject(e)})}removeAndDestroySingleLayer_(e){const t=a(e).toString(),i=this.layerMap[t];return i&&(i.forEach(e=>{this.removeSingleCesiumObject(e,!1),this.destroyCesiumObject(e)}),this.olLayerListenKeys[t].forEach(O.unByKey),delete this.olLayerListenKeys[t]),delete this.layerMap[t],!!i}unlistenSingleGroup_(e){if(e===this.mapLayerGroup)return;const t=a(e).toString();this.olGroupListenKeys_[t].forEach(e=>{Object(O.unByKey)(e)}),delete this.olGroupListenKeys_[t],delete this.layerMap[t]}removeLayer_(e){if(e){const t=[e];for(;t.length>0;){const e=t.splice(0,1)[0],i=this.removeAndDestroySingleLayer_(e);e instanceof k.a&&(this.unlistenSingleGroup_(e),i||e.getLayers().forEach(e=>{t.push(e)}))}}}listenForGroupChanges_(e){const t=a(e).toString(),i=[];this.olGroupListenKeys_[t]=i;let n=[];const s=function(){const t=e.getLayers();t&&(n=[t.on("add",e=>{this.addLayers_(e.element)}),t.on("remove",e=>{this.removeLayer_(e.element)})],i.push(...n))}.bind(this);s(),i.push(e.on("change:layers",e=>{n.forEach(e=>{const t=i.indexOf(e);t>=0&&i.splice(t,1),Object(O.unByKey)(e)}),s()}))}destroyAll(){let e;for(e in this.removeAllCesiumObjects(!0),this.olGroupListenKeys_)this.olGroupListenKeys_[e].forEach(O.unByKey);for(e in this.olLayerListenKeys)this.olLayerListenKeys[e].forEach(O.unByKey);this.olGroupListenKeys_={},this.olLayerListenKeys={},this.layerMap={}}addCesiumObject(e){}destroyCesiumObject(e){}removeSingleCesiumObject(e,t){}removeAllCesiumObjects(e){}createSingleLayerCounterparts(e){}};var j=class extends V{constructor(e,t){super(e,t),this.cesiumLayers_=t.imageryLayers,this.ourLayers_=new Cesium.ImageryLayerCollection}addCesiumObject(e){this.cesiumLayers_.add(e),this.ourLayers_.add(e)}destroyCesiumObject(e){e.destroy()}removeSingleCesiumObject(e,t){this.cesiumLayers_.remove(e,t),this.ourLayers_.remove(e,!1)}removeAllCesiumObjects(e){for(let t=0;t<this.ourLayers_.length;++t)this.cesiumLayers_.remove(this.ourLayers_.get(t),e);this.ourLayers_.removeAll(!1)}convertLayerToCesiumImageries(e,t){const i=R.tileLayerToImageryLayer(this.map,e,t);return i?[i]:null}createSingleLayerCounterparts(e){const t=e.layer,i=a(t).toString(),n=this.view.getProjection(),s=this.convertLayerToCesiumImageries(t,n);if(s){const n=[];[e.layer].concat(e.parents).forEach(t=>{n.push(t.on(["change:opacity","change:visible"],()=>{for(let t=0;t<s.length;++t)R.updateCesiumLayerProperties(e,s[t])}))});for(let t=0;t<s.length;++t)R.updateCesiumLayerProperties(e,s[t]);n.push(t.on("change:extent",e=>{for(let e=0;e<s.length;++e)this.cesiumLayers_.remove(s[e],!0),this.ourLayers_.remove(s[e],!1);delete this.layerMap[a(t)],this.synchronize()})),n.push(t.on("change",e=>{for(let e=0;e<s.length;++e){const t=this.cesiumLayers_.indexOf(s[e]);t>=0&&(this.cesiumLayers_.remove(s[e],!1),this.cesiumLayers_.add(s[e],t))}})),this.olLayerListenKeys[i].push(...n)}return Array.isArray(s)?s:null}orderLayers(){const e=[],t={},i=[this.mapLayerGroup];for(;i.length>0;){const n=i.splice(0,1)[0];if(e.push(n),t[a(n)]=n.getZIndex(),n instanceof k.a){const e=n.getLayers();e&&i.unshift(...e.getArray())}}!function(e,t){const i=e.length,n=Array(e.length);for(let t=0;t<i;t++)n[t]={index:t,value:e[t]};n.sort((e,i)=>t(e.value,i.value)||e.index-i.index);for(let t=0;t<e.length;t++)e[t]=n[t].value}(e,(e,i)=>t[a(e)]-t[a(i)]),e.forEach(e=>{const t=a(e).toString(),i=this.layerMap[t];i&&i.forEach(e=>{this.raiseToTop(e)})})}raiseToTop(e){this.cesiumLayers_.raiseToTop(e)}},N=(i(3),i(18),i(5)),D=i.n(N),B=i(6),H=i.n(B),z=i(19),U=i.n(z),W=i(7),K=i.n(W),q=i(8),Z=i.n(q),Q=i(20),Y=i(9),$=i(21),X=i.n($);var J=class{constructor(e,t){const i=new Cesium.BillboardCollection({scene:t}),n=new Cesium.PrimitiveCollection;this.olListenKeys=[],this.rootCollection_=new Cesium.PrimitiveCollection,this.context={projection:e,billboards:i,featureToCesiumMap:{},primitives:n},this.rootCollection_.add(i),this.rootCollection_.add(n)}destroy(){this.olListenKeys.forEach(O.unByKey),this.olListenKeys.length=0}getRootPrimitive(){return this.rootCollection_}};var ee=class{constructor(e){this.scene=e,this.boundOnRemoveOrClearFeatureListener_=this.onRemoveOrClearFeature_.bind(this),this.defaultBillboardEyeOffset_=new Cesium.Cartesian3(0,0,10)}onRemoveOrClearFeature_(e){const t=e.target,i=c.obj(t).olcs_cancellers;if(i){const n=e.feature;if(n){const e=a(n),t=i[e];t&&(t(),delete i[e])}else{for(const e in i)i.hasOwnProperty(e)&&i[e]();c.obj(t).olcs_cancellers={}}}}setReferenceForPicking(e,t,i){i.olLayer=e,i.olFeature=t}createColoredPrimitive(e,t,i,n,s,r){const o={flat:!0,renderState:{depthTest:{enabled:!0}}};void 0!==r&&(o.renderState||(o.renderState={}),o.renderState.lineWidth=r);const a=function(e,t){const i=new Cesium.GeometryInstance({geometry:e});return!t||t instanceof Cesium.ImageMaterialProperty||(i.attributes={color:Cesium.ColorGeometryInstanceAttribute.fromColor(t)}),i}(n,s);let l;if(this.getHeightReference(e,t,i)===Cesium.HeightReference.CLAMP_TO_GROUND){const e=a.geometry.constructor;if(e&&!e.createShadowVolume)return null;l=new Cesium.GroundPrimitive({geometryInstances:a})}else l=new Cesium.Primitive({geometryInstances:a});if(s instanceof Cesium.ImageMaterialProperty){const e=s.image.getValue().toDataURL();l.appearance=new Cesium.MaterialAppearance({flat:!0,renderState:{depthTest:{enabled:!0}},material:new Cesium.Material({fabric:{type:"Image",uniforms:{image:e}}})})}else l.appearance=new Cesium.PerInstanceColorAppearance(o);return this.setReferenceForPicking(e,t,l),l}extractColorFromOlStyle(e,t){const i=e.getFill()?e.getFill().getColor():null,n=e.getStroke()?e.getStroke().getColor():null;let s="black";return n&&t?s=n:i&&(s=i),R.convertColorToCesium(s)}extractLineWidthFromOlStyle(e){const t=e.getStroke()?e.getStroke().getWidth():void 0;return void 0!==t?t:1}wrapFillAndOutlineGeometries(e,t,i,n,s,r){const o=this.extractColorFromOlStyle(r,!1),a=this.extractColorFromOlStyle(r,!0),l=new Cesium.PrimitiveCollection;if(r.getFill()){const s=this.createColoredPrimitive(e,t,i,n,o);l.add(s)}if(r.getStroke()&&s){const n=this.extractLineWidthFromOlStyle(r),o=this.createColoredPrimitive(e,t,i,s,a,n);o&&l.add(o)}return l}addTextStyle(e,t,i,n,s){let r;if(s instanceof Cesium.PrimitiveCollection?r=s:(r=new Cesium.PrimitiveCollection).add(s),!n.getText())return r;const o=n.getText(),a=this.olGeometry4326TextPartToCesium(e,t,i,o);return a&&r.add(a),r}csAddBillboard(e,t,i,n,s,r){t.eyeOffset||(t.eyeOffset=this.defaultBillboardEyeOffset_);const o=e.add(t);return this.setReferenceForPicking(i,n,o),o}olCircleGeometryToCesium(e,t,i,n,s){let r=(i=R.olGeometryCloneTo4326(i,n)).getCenter();const o=3==r.length?r[2]:0;let a=r.slice();a[0]+=i.getRadius(),r=R.ol4326CoordinateToCesiumCartesian(r),a=R.ol4326CoordinateToCesiumCartesian(a);const c=Cesium.Cartesian3.distance(r,a),u=new Cesium.CircleGeometry({center:r,radius:c,height:o});let h,m;if(this.getHeightReference(e,t,i)===Cesium.HeightReference.CLAMP_TO_GROUND){const n=this.extractLineWidthFromOlStyle(s);if(n){const r=Object(Q.circular)(i.getCenter(),c),o=R.ol4326CoordinateArrayToCsCartesians(r.getLinearRing(0).getCoordinates());if(l(this.scene))(h=new Cesium.GroundPolylinePrimitive({geometryInstances:new Cesium.GeometryInstance({geometry:new Cesium.GroundPolylineGeometry({positions:o,width:n})}),appearance:new Cesium.PolylineMaterialAppearance({material:this.olStyleToCesium(t,s,!0)}),classificationType:Cesium.ClassificationType.TERRAIN})).readyPromise.then(()=>{this.setReferenceForPicking(e,t,h._primitive)});else{const i=this.extractColorFromOlStyle(s,!0);h=this.createStackedGroundCorridors(e,t,n,i,o)}}}else m=new Cesium.CircleOutlineGeometry({center:r,radius:c,extrudedHeight:o,height:o});const d=this.wrapFillAndOutlineGeometries(e,t,i,u,m,s);return h&&d.add(h),this.addTextStyle(e,t,i,s,d)}createStackedGroundCorridors(e,t,i,n,s){Array.isArray(s[0])||(s=[s]),i=Math.max(3,i);const r=[];let o=0;for(const e of[1e3,4e3,16e3,64e3,254e3,1e6,1e7]){const t={width:i*=2.14,vertexFormat:Cesium.VertexFormat.POSITION_ONLY};for(const i of s)t.positions=i,r.push(new Cesium.GeometryInstance({geometry:new Cesium.CorridorGeometry(t),attributes:{color:Cesium.ColorGeometryInstanceAttribute.fromColor(n),distanceDisplayCondition:new Cesium.DistanceDisplayConditionGeometryInstanceAttribute(o,e-1)}}));o=e}return new Cesium.GroundPrimitive({geometryInstances:r})}olLineStringGeometryToCesium(e,t,i,n,s){i=R.olGeometryCloneTo4326(i,n);const r=R.ol4326CoordinateArrayToCsCartesians(i.getCoordinates()),o=this.extractLineWidthFromOlStyle(s);let a;const c=this.getHeightReference(e,t,i);if(c!==Cesium.HeightReference.CLAMP_TO_GROUND||l(this.scene)){const i=new Cesium.PolylineMaterialAppearance({material:this.olStyleToCesium(t,s,!0)}),n={positions:r,width:o},l={appearance:i};if(c===Cesium.HeightReference.CLAMP_TO_GROUND){const i=new Cesium.GroundPolylineGeometry(n);l.geometryInstances=new Cesium.GeometryInstance({geometry:i}),(a=new Cesium.GroundPolylinePrimitive(l)).readyPromise.then(()=>{this.setReferenceForPicking(e,t,a._primitive)})}else{n.vertexFormat=i.vertexFormat;const e=new Cesium.PolylineGeometry(n);l.geometryInstances=new Cesium.GeometryInstance({geometry:e}),a=new Cesium.Primitive(l)}}else{const i=this.extractColorFromOlStyle(s,!0);a=this.createStackedGroundCorridors(e,t,o,i,r)}return this.setReferenceForPicking(e,t,a),this.addTextStyle(e,t,i,s,a)}olPolygonGeometryToCesium(e,t,i,n,s){i=R.olGeometryCloneTo4326(i,n);const r=this.getHeightReference(e,t,i);let o,a,c;if(5==i.getCoordinates()[0].length&&"rectangle"===t.getGeometry().get("olcs.polygon_kind")){const e=i.getCoordinates()[0],t=Object(Y.boundingExtent)(e),n=Cesium.Rectangle.fromDegrees(t[0],t[1],t[2],t[3]);let s=0;if(3==e[0].length)for(let t=0;t<e.length;t++)s=Math.max(s,e[t][2]);o=new Cesium.RectangleGeometry({ellipsoid:Cesium.Ellipsoid.WGS84,rectangle:n,height:s}),a=new Cesium.RectangleOutlineGeometry({ellipsoid:Cesium.Ellipsoid.WGS84,rectangle:n,height:s})}else{const n=i.getLinearRings(),u={},h=u;for(let e=0;e<n.length;++e){const t=n[e].getCoordinates(),i=R.ol4326CoordinateArrayToCsCartesians(t);0==e?u.positions=i:(u.holes||(u.holes=[]),u.holes.push({positions:i}))}if(o=new Cesium.PolygonGeometry({polygonHierarchy:h,perPositionHeight:!0}),r===Cesium.HeightReference.CLAMP_TO_GROUND){const i=this.extractLineWidthFromOlStyle(s);if(i>0){const n=[u.positions];if(u.holes)for(let e=0;e<u.holes.length;++e)n.push(u.holes[e].positions);if(l(this.scene)){const r=new Cesium.PolylineMaterialAppearance({material:this.olStyleToCesium(t,s,!0)}),o=[];for(const e of n){const t=new Cesium.GroundPolylineGeometry({positions:e,width:i});o.push(new Cesium.GeometryInstance({geometry:t}))}const a={appearance:r,geometryInstances:o};(c=new Cesium.GroundPolylinePrimitive(a)).readyPromise.then(()=>{this.setReferenceForPicking(e,t,c._primitive)})}else{const r=this.extractColorFromOlStyle(s,!0);c=this.createStackedGroundCorridors(e,t,i,r,n)}}}else a=new Cesium.PolygonOutlineGeometry({polygonHierarchy:u,perPositionHeight:!0})}const u=this.wrapFillAndOutlineGeometries(e,t,i,o,a,s);return c&&u.add(c),this.addTextStyle(e,t,i,s,u)}getHeightReference(e,t,i){let n=i.get("altitudeMode");void 0===n&&(n=t.get("altitudeMode")),void 0===n&&(n=e.get("altitudeMode"));let s=Cesium.HeightReference.NONE;return"clampToGround"===n?s=Cesium.HeightReference.CLAMP_TO_GROUND:"relativeToGround"===n&&(s=Cesium.HeightReference.RELATIVE_TO_GROUND),s}createBillboardFromImage(e,t,i,n,s,r,o,l){r instanceof Z.a&&r.load();const u=r.getImage(1),h=function(){if(!u)return;if(!(u instanceof HTMLCanvasElement||u instanceof Image||u instanceof HTMLImageElement))return;const n=i.getCoordinates(),a=R.ol4326CoordinateToCesiumCartesian(n);let c;const h=r.getOpacity();void 0!==h&&(c=new Cesium.Color(1,1,1,h));const m=this.getHeightReference(e,t,i),d={image:u,color:c,scale:r.getScale(),heightReference:m,position:a};if(r instanceof Z.a){const e=r.getAnchor();e&&(d.pixelOffset=new Cesium.Cartesian2(u.width/2-e[0],u.height/2-e[1]))}const g=this.csAddBillboard(o,d,e,t,i,s);l&&l(g)}.bind(this);if(u instanceof Image&&!function(e){return""!=e.src&&0!=e.naturalHeight&&0!=e.naturalWidth&&e.complete}(u)){let i=!1;const n=e.getSource(),s=function(){i=!0};n.on(["removefeature","clear"],this.boundOnRemoveOrClearFeatureListener_);let r=c.obj(n).olcs_cancellers;r||(r=c.obj(n).olcs_cancellers={});const l=a(t);r[l]&&r[l](),r[l]=s;const m=function(){u.removeEventListener("load",m),o.isDestroyed()||i||h()};u.addEventListener("load",m)}else h()}olPointGeometryToCesium(e,t,i,n,s,r,o){i=R.olGeometryCloneTo4326(i,n);let a=null;const l=s.getImage();if(l){const c=i.get("olcs_model")||t.get("olcs_model");if(c){const e=c(),t=Object.assign({},{scene:this.scene},e.cesiumOptions),i=Cesium.Model.fromGltf(t);(a=new Cesium.PrimitiveCollection).add(i),e.debugModelMatrix&&a.add(new Cesium.DebugModelMatrixPrimitive({modelMatrix:e.debugModelMatrix}))}else this.createBillboardFromImage(e,t,i,n,s,l,r,o)}return s.getText()?this.addTextStyle(e,t,i,s,a||new Cesium.Primitive):a}olMultiGeometryToCesium(e,t,i,n,s,r,o){const a=function(i,r){const o=new Cesium.PrimitiveCollection;return i.forEach(i=>{o.add(r(e,t,i,n,s))}),o};let l;switch(i.getType()){case"MultiPoint":if(l=(i=i).getPoints(),s.getText()){const i=new Cesium.PrimitiveCollection;return l.forEach(a=>{const l=this.olPointGeometryToCesium(e,t,a,n,s,r,o);l&&i.add(l)}),i}return l.forEach(i=>{this.olPointGeometryToCesium(e,t,i,n,s,r,o)}),null;case"MultiLineString":return a(l=(i=i).getLineStrings(),this.olLineStringGeometryToCesium.bind(this));case"MultiPolygon":return a(l=(i=i).getPolygons(),this.olPolygonGeometryToCesium.bind(this))}}olGeometry4326TextPartToCesium(e,t,i,n){const s=n.getText();if(!s)return null;const r=new Cesium.LabelCollection({scene:this.scene}),o=Object(Y.getCenter)(i.getExtent());if(i instanceof X.a){const e=i.getFirstCoordinate();o[2]=3==e.length?e[2]:0}const a={};a.position=R.ol4326CoordinateToCesiumCartesian(o),a.text=s,a.heightReference=this.getHeightReference(e,t,i);const l=n.getOffsetX(),c=n.getOffsetY();if(0!=l&&0!=c){const e=new Cesium.Cartesian2(l,c);a.pixelOffset=e}a.font=n.getFont()||"10px sans-serif";let u,h=void 0;switch(n.getFill()&&(a.fillColor=this.extractColorFromOlStyle(n,!1),h=Cesium.LabelStyle.FILL),n.getStroke()&&(a.outlineWidth=this.extractLineWidthFromOlStyle(n),a.outlineColor=this.extractColorFromOlStyle(n,!0),h=Cesium.LabelStyle.OUTLINE),n.getFill()&&n.getStroke()&&(h=Cesium.LabelStyle.FILL_AND_OUTLINE),a.style=h,n.getTextAlign()){case"left":u=Cesium.HorizontalOrigin.LEFT;break;case"right":u=Cesium.HorizontalOrigin.RIGHT;break;case"center":default:u=Cesium.HorizontalOrigin.CENTER}if(a.horizontalOrigin=u,n.getTextBaseline()){let e;switch(n.getTextBaseline()){case"top":e=Cesium.VerticalOrigin.TOP;break;case"middle":e=Cesium.VerticalOrigin.CENTER;break;case"bottom":e=Cesium.VerticalOrigin.BOTTOM;break;case"alphabetic":e=Cesium.VerticalOrigin.TOP;break;case"hanging":e=Cesium.VerticalOrigin.BOTTOM}a.verticalOrigin=e}const m=r.add(a);return this.setReferenceForPicking(e,t,m),r}olStyleToCesium(e,t,i){const n=t.getFill(),s=t.getStroke();if(i&&!s||!i&&!n)return null;let r=i?s.getColor():n.getColor();return r=R.convertColorToCesium(r),i&&s.getLineDash()?Cesium.Material.fromType("Stripe",{horizontal:!1,repeat:500,evenColor:r,oddColor:new Cesium.Color(0,0,0,0)}):Cesium.Material.fromType("Color",{color:r})}computePlainStyle(e,t,i,n){const s=t.getStyleFunction();let r=null;return s&&(r=s(t,n)),!r&&i&&(r=i(t,n)),r?Array.isArray(r)?r:[r]:null}getGeometryFromFeature(e,t,i){if(i)return i;const n=e.get("olcs.3d_geometry");if(n&&n instanceof K.a)return n;if(t){const i=t.getGeometryFunction()(e);if(i instanceof K.a)return i}return e.getGeometry()}olFeatureToCesium(e,t,i,n,s){let r=this.getGeometryFromFeature(t,i,s);if(!r)return null;const o=n.projection,l=function(e){const i=n.featureToCesiumMap[a(t)];i instanceof Array?i.push(e):n.featureToCesiumMap[a(t)]=[e]};switch(r.getType()){case"GeometryCollection":const s=new Cesium.PrimitiveCollection;return r.getGeometries().forEach(r=>{if(r){const o=this.olFeatureToCesium(e,t,i,n,r);o&&s.add(o)}}),s;case"Point":r=r;const a=n.billboards,c=this.olPointGeometryToCesium(e,t,r,o,i,a,l);return c||null;case"Circle":return r=r,this.olCircleGeometryToCesium(e,t,r,o,i);case"LineString":return r=r,this.olLineStringGeometryToCesium(e,t,r,o,i);case"Polygon":return r=r,this.olPolygonGeometryToCesium(e,t,r,o,i);case"MultiPoint":case"MultiLineString":case"MultiPolygon":const u=this.olMultiGeometryToCesium(e,t,r,o,i,n.billboards,l);return u||null;case"LinearRing":throw new Error("LinearRing should only be part of polygon.");default:throw new Error(`Ol geom type not handled : ${r.getType()}`)}}olVectorLayerToCesium(e,t,i){const n=t.getProjection(),s=t.getResolution();if(void 0===s||!n)throw new Error("View not ready");let r=e.getSource();r instanceof D.a&&(r=r.getSource());const o=r.getFeatures(),l=new J(n,this.scene),c=l.context;for(let t=0;t<o.length;++t){const n=o[t];if(!n)continue;const r=e.getStyleFunction(),u=this.computePlainStyle(e,n,r,s);if(!u||!u.length)continue;let h=null;for(let t=0;t<u.length;t++){const i=this.olFeatureToCesium(e,n,u[t],c);if(i)if(h){if(i){let e,t=0;for(;e=i.get(t);)h.add(e),t++}}else h=i}h&&(i[a(n)]=h,l.getRootPrimitive().add(h))}return l}convert(e,t,i,n){const s=t.getProjection(),r=t.getResolution();if(null==r||!s)return null;const o=e.getStyleFunction(),a=this.computePlainStyle(e,i,o,r);if(!a||!a.length)return null;n.projection=s;let l=null;for(let t=0;t<a.length;t++){const s=this.olFeatureToCesium(e,i,a[t],n);if(l){if(s){let e,t=0;for(;e=s.get(t);)l.add(e),t++}}else l=s}return l}};var te=class extends V{constructor(e,t,i){super(e,t),this.converter=i||new ee(t),this.csAllPrimitives_=new Cesium.PrimitiveCollection,t.primitives.add(this.csAllPrimitives_),this.csAllPrimitives_.destroyPrimitives=!1}addCesiumObject(e){e.getRootPrimitive().counterpart=e,this.csAllPrimitives_.add(e.getRootPrimitive())}destroyCesiumObject(e){e.getRootPrimitive().destroy()}removeSingleCesiumObject(e,t){e.destroy(),this.csAllPrimitives_.destroyPrimitives=t,this.csAllPrimitives_.remove(e.getRootPrimitive()),this.csAllPrimitives_.destroyPrimitives=!1}removeAllCesiumObjects(e){if(this.csAllPrimitives_.destroyPrimitives=e,e)for(let e=0;e<this.csAllPrimitives_.length;++e)this.csAllPrimitives_.get(e).counterpart.destroy();this.csAllPrimitives_.removeAll(),this.csAllPrimitives_.destroyPrimitives=!1}updateLayerVisibility(e,t){let i=!0;[e.layer].concat(e.parents).forEach(e=>{const t=e.getVisible();void 0!==t?i&=t:i=!1}),t.show=i}createSingleLayerCounterparts(e){const t=e.layer;if(!(t instanceof H.a)||t instanceof U.a)return null;let i=t.getSource();if(i instanceof D.a&&(i=i.getSource()),!i)return null;const n=this.view,s={},o=this.converter.olVectorLayerToCesium(t,n,s),l=o.getRootPrimitive(),c=o.olListenKeys;[e.layer].concat(e.parents).forEach(t=>{c.push(r(t,"change:visible",()=>{this.updateLayerVisibility(e,l)}))}),this.updateLayerVisibility(e,l);const u=function(e){const i=o.context,r=this.converter.convert(t,n,e,i);r&&(s[a(e)]=r,l.add(r))}.bind(this),h=function(e){const t=a(e),i=o.context,n=i.featureToCesiumMap[t];n&&(delete i.featureToCesiumMap[t],n.forEach(e=>{e instanceof Cesium.Billboard&&i.billboards.remove(e)}));const r=s[t];delete s[t],r&&l.remove(r)}.bind(this);return c.push(r(i,"addfeature",e=>{u(e.feature)})),c.push(r(i,"removefeature",e=>{h(e.feature)})),c.push(r(i,"changefeature",e=>{const t=e.feature;h(t),u(t)})),o?[o]:null}},ie=i(22),ne=i.n(ie);var se=class extends ne.a{constructor(e){const t=e.parent;super(t.getOptions()),this.scenePostRenderListenerRemover_=null,this.scene_=e.scene,this.synchronizer_=e.synchronizer,this.parent_=t,this.positionWGS84_=void 0,this.observer_=new MutationObserver(this.handleElementChanged.bind(this)),this.attributeObserver_=[],this.listenerKeys_=[];const i=e=>this.setPropertyFromEvent_(e);this.listenerKeys_.push(this.parent_.on("change:position",i)),this.listenerKeys_.push(this.parent_.on("change:element",i)),this.listenerKeys_.push(this.parent_.on("change:offset",i)),this.listenerKeys_.push(this.parent_.on("change:position",i)),this.listenerKeys_.push(this.parent_.on("change:positioning",i)),this.setProperties(this.parent_.getProperties()),this.handleMapChanged(),this.handleElementChanged()}observeTarget_(e){if(this.observer_){this.observer_.disconnect(),this.observer_.observe(e,{attributes:!1,childList:!0,characterData:!0,subtree:!0}),this.attributeObserver_.forEach(e=>{e.disconnect()}),this.attributeObserver_.length=0;for(let t=0;t<e.childNodes.length;t++){const i=e.childNodes[t];if(1===i.nodeType){const e=new MutationObserver(this.handleElementChanged.bind(this));e.observe(i,{attributes:!0,subtree:!0}),this.attributeObserver_.push(e)}}}}setPropertyFromEvent_(e){e.target&&e.key&&this.set(e.key,e.target.get(e.key))}getScene(){return this.scene_}handleMapChanged(){var e;this.scenePostRenderListenerRemover_&&(this.scenePostRenderListenerRemover_(),(e=this.element)&&e.parentNode&&e.parentNode.removeChild(e)),this.scenePostRenderListenerRemover_=null;const t=this.getScene();if(t){this.scenePostRenderListenerRemover_=t.postRender.addEventListener(this.updatePixelPosition.bind(this)),this.updatePixelPosition();const e=this.stopEvent?this.synchronizer_.getOverlayContainerStopEvent():this.synchronizer_.getOverlayContainer();this.insertFirst?e.insertBefore(this.element,e.childNodes[0]||null):e.appendChild(this.element)}}handlePositionChanged(){const e=this.getPosition();if(e){const t=this.parent_.getMap().getView().getProjection();this.positionWGS84_=Object(n.transform)(e,t,"EPSG:4326")}else this.positionWGS84_=void 0;this.updatePixelPosition()}handleElementChanged(){function e(t,i){const n=t.cloneNode();i&&i.appendChild(n),t.nodeType!=Node.TEXT_NODE&&n.addEventListener("click",e=>{t.dispatchEvent(new MouseEvent("click",e)),e.stopPropagation()});const s=t.childNodes;for(let t=0;t<s.length;t++)s[t]&&e(s[t],n);return n}!function(e){for(;e.lastChild;)e.removeChild(e.lastChild)}(this.element);const t=this.getElement();if(t&&t.parentNode&&t.parentNode.childNodes)for(const i of t.parentNode.childNodes){const t=e(i,null);this.element.appendChild(t)}t&&t.parentNode&&this.observeTarget_(t.parentNode)}updatePixelPosition(){const e=this.positionWGS84_;if(!this.scene_||!e)return void this.setVisible(!1);let t=0;if(2===e.length){const i=this.scene_.globe.getHeight(Cesium.Cartographic.fromDegrees(e[0],e[1]));i&&this.scene_.globe.tilesLoaded&&(e[2]=i),i&&(t=i)}else t=e[2];const i=Cesium.Cartesian3.fromDegrees(e[0],e[1],t),n=this.scene_.camera,s=new Cesium.BoundingSphere(new Cesium.Cartesian3,6356752);if(!new Cesium.Occluder(s,n.position).isPointVisible(i))return void this.setVisible(!1);if(1!==n.frustum.computeCullingVolume(n.position,n.direction,n.up).computeVisibility(new Cesium.BoundingSphere(i)))return void this.setVisible(!1);this.setVisible(!0);const r=this.scene_.cartesianToCanvasCoordinates(i),o=[r.x,r.y],a=[this.scene_.canvas.width,this.scene_.canvas.height];this.updateRenderedPosition(o,a)}destroy(){this.scenePostRenderListenerRemover_&&this.scenePostRenderListenerRemover_(),this.observer_&&this.observer_.disconnect(),Object(O.unByKey)(this.listenerKeys_),this.listenerKeys_.splice(0),this.element.removeNode?this.element.removeNode(!0):this.element.remove(),this.element=null}};var re=class{constructor(e,t){this.map=e,this.overlays_=this.map.getOverlays(),this.scene=t,this.overlayContainerStopEvent_=document.createElement("DIV"),this.overlayContainerStopEvent_.className="ol-overlaycontainer-stopevent",["click","dblclick","mousedown","touchstart","MSPointerDown","pointerdown","mousewheel","wheel"].forEach(e=>{this.overlayContainerStopEvent_.addEventListener(e,e=>e.stopPropagation())}),this.scene.canvas.parentElement.appendChild(this.overlayContainerStopEvent_),this.overlayContainer_=document.createElement("DIV"),this.overlayContainer_.className="ol-overlaycontainer",this.scene.canvas.parentElement.appendChild(this.overlayContainer_),this.overlayMap_={}}getOverlayContainerStopEvent(){return this.overlayContainerStopEvent_}getOverlayContainer(){return this.overlayContainer_}synchronize(){this.destroyAll(),this.addOverlays(),this.overlays_.on("add",this.addOverlayFromEvent_.bind(this)),this.overlays_.on("remove",this.removeOverlayFromEvent_.bind(this))}addOverlayFromEvent_(e){const t=e.element;this.addOverlay(t)}addOverlays(){this.overlays_.forEach(e=>{this.addOverlay(e)})}addOverlay(e){if(!e)return;const t=new se({scene:this.scene,synchronizer:this,parent:e}),i=a(e).toString();this.overlayMap_[i]=t}removeOverlayFromEvent_(e){const t=e.element;this.removeOverlay(t)}removeOverlay(e){const t=a(e).toString(),i=this.overlayMap_[t];i&&(i.destroy(),delete this.overlayMap_[t])}destroyAll(){Object.keys(this.overlayMap_).forEach(e=>{this.overlayMap_[e].destroy(),delete this.overlayMap_[e]})}};class oe{constructor(e){this.autoRenderLoop_=null,this.map_=e.map,this.time_=e.time||function(){return Cesium.JulianDate.now()},this.to4326Transform_=Object(n.getTransform)(this.map_.getView().getProjection(),"EPSG:4326"),this.resolutionScale_=1,this.canvasClientWidth_=0,this.canvasClientHeight_=0,this.resolutionScaleChanged_=!0;const t="position:absolute;top:0;left:0;width:100%;height:100%;";this.container_=document.createElement("DIV");const i=document.createAttribute("style");i.value=`${t}visibility:hidden;`,this.container_.setAttributeNode(i);let s=e.target||null;if(s)"string"==typeof s&&(s=document.getElementById(s)),s.appendChild(this.container_);else{const e=this.map_.getViewport().querySelector(".ol-overlaycontainer");e&&e.parentNode&&e.parentNode.insertBefore(this.container_,e)}if(this.isOverMap_=!s,this.isOverMap_&&e.stopOpenLayersEventsPropagation){const e=["click","dblclick","mousedown","touchstart","MSPointerDown","pointerdown","mousewheel","wheel"];for(let t=0,i=e.length;t<i;++t)this.container_.addEventListener(e[t],e=>e.stopPropagation())}this.canvas_=document.createElement("CANVAS");const r=document.createAttribute("style");r.value=t,this.canvas_.setAttributeNode(r),c.supportsImageRenderingPixelated()&&(this.canvas_.style.imageRendering=c.imageRenderingValue()),this.canvas_.oncontextmenu=function(){return!1},this.canvas_.onselectstart=function(){return!1},this.container_.appendChild(this.canvas_),this.enabled_=!1,this.pausedInteractions_=[],this.hiddenRootGroup_=null;const o=void 0!==e.sceneOptions?e.sceneOptions:{};o.canvas=this.canvas_,o.scene3DOnly=!0,this.scene_=new Cesium.Scene(o);const a=this.scene_.screenSpaceCameraController;a.tiltEventTypes.push({eventType:Cesium.CameraEventType.LEFT_DRAG,modifier:Cesium.KeyboardEventModifier.SHIFT}),a.tiltEventTypes.push({eventType:Cesium.CameraEventType.LEFT_DRAG,modifier:Cesium.KeyboardEventModifier.ALT}),a.enableLook=!1,this.scene_.camera.constrainedAxis=Cesium.Cartesian3.UNIT_Z,this.camera_=new M(this.scene_,this.map_),this.globe_=new Cesium.Globe(Cesium.Ellipsoid.WGS84),this.globe_.baseColor=Cesium.Color.WHITE,this.scene_.globe=this.globe_,this.scene_.skyAtmosphere=new Cesium.SkyAtmosphere;const l=new Cesium.SingleTileImageryProvider({url:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=",rectangle:Cesium.Rectangle.fromDegrees(0,0,1,1)});this.globe_.imageryLayers.addImageryProvider(l,0),this.dataSourceCollection_=new Cesium.DataSourceCollection,this.dataSourceDisplay_=new Cesium.DataSourceDisplay({scene:this.scene_,dataSourceCollection:this.dataSourceCollection_});const u=e.createSynchronizers?e.createSynchronizers(this.map_,this.scene_,this.dataSourceCollection_):[new j(this.map_,this.scene_),new te(this.map_,this.scene_),new re(this.map_,this.scene_)];this.handleResize_();for(let e=u.length-1;e>=0;--e)u[e].synchronize();this.lastFrameTime_=0,this.renderId_=void 0,this.targetFrameRate_=Number.POSITIVE_INFINITY,this.blockCesiumRendering_=!1,this.warmingUp_=!1,this.trackedFeature_=null,this.trackedEntity_=null,this.entityView_=null,this.needTrackedEntityUpdate_=!1,this.boundingSphereScratch_=new Cesium.BoundingSphere,(new Cesium.EventHelper).add(this.scene_.postRender,oe.prototype.updateTrackedEntity_,this),Cesium.Camera.enableSuspendTerrainAdjustment=!1}render_(){void 0!==this.renderId_&&(cancelAnimationFrame(this.renderId_),this.renderId_=void 0),!this.enabled_&&!this.warmingUp_||this.blockCesiumRendering_||(this.renderId_=requestAnimationFrame(this.onAnimationFrame_.bind(this)))}onAnimationFrame_(e){this.renderId_=void 0;const t=1e3/this.targetFrameRate_;if(e-this.lastFrameTime_<t)return void this.render_();this.lastFrameTime_=e;const i=this.time_();if(this.scene_.initializeFrame(),this.handleResize_(),this.dataSourceDisplay_.update(i),this.entityView_){const e=this.trackedEntity_;this.dataSourceDisplay_.getBoundingSphere(e,!1,this.boundingSphereScratch_)===Cesium.BoundingSphereState.DONE&&(this.boundingSphereScratch_.radius=1,this.entityView_.update(i,this.boundingSphereScratch_))}this.scene_.render(i),this.camera_.checkCameraChange(),this.render_()}updateTrackedEntity_(){if(!this.needTrackedEntityUpdate_)return;const e=this.trackedEntity_,t=this.scene_,i=this.dataSourceDisplay_.getBoundingSphere(e,!1,this.boundingSphereScratch_);if(i===Cesium.BoundingSphereState.PENDING)return;t.screenSpaceCameraController.enableTilt=!1;const n=i!==Cesium.BoundingSphereState.FAILED?this.boundingSphereScratch_:void 0;n&&(n.radius=1),this.entityView_=new Cesium.EntityView(e,t,t.mapProjection.ellipsoid),this.entityView_.update(this.time_(),n),this.needTrackedEntityUpdate_=!1}handleResize_(){let e=this.canvas_.clientWidth,t=this.canvas_.clientHeight;if(0===e|0===t)return;if(e===this.canvasClientWidth_&&t===this.canvasClientHeight_&&!this.resolutionScaleChanged_)return;let i=this.resolutionScale_;c.supportsImageRenderingPixelated()||(i*=window.devicePixelRatio||1),this.resolutionScaleChanged_=!1,this.canvasClientWidth_=e,this.canvasClientHeight_=t,e*=i,t*=i,this.canvas_.width=e,this.canvas_.height=t,this.scene_.camera.frustum.aspectRatio=e/t}getCamera(){return this.camera_}getOlMap(){return this.map_}getOlView(){return this.map_.getView()}getCesiumScene(){return this.scene_}getDataSources(){return this.dataSourceCollection_}getDataSourceDisplay(){return this.dataSourceDisplay_}getEnabled(){return this.enabled_}setEnabled(e){if(this.enabled_===e)return;let t;if(this.enabled_=e,this.container_.style.visibility=this.enabled_?"visible":"hidden",this.enabled_){if(this.throwOnUnitializedMap_(),this.isOverMap_){(t=this.map_.getInteractions()).forEach((e,t,i)=>{this.pausedInteractions_.push(e)}),t.clear(),this.map_.addInteraction=e=>this.pausedInteractions_.push(e),this.map_.removeInteraction=e=>this.pausedInteractions_=this.pausedInteractions_.filter(t=>t!==e);const e=this.map_.getLayerGroup();e.getVisible()&&(this.hiddenRootGroup_=e,this.hiddenRootGroup_.setVisible(!1)),this.map_.getOverlayContainer().classList.add("olcs-hideoverlay"),this.map_.getOverlayContainerStopEvent().classList.add("olcs-hideoverlay")}this.camera_.readFromView(),this.render_()}else this.isOverMap_&&(t=this.map_.getInteractions(),this.pausedInteractions_.forEach(e=>{t.push(e)}),this.pausedInteractions_.length=0,this.map_.addInteraction=e=>this.map_.getInteractions().push(e),this.map_.removeInteraction=e=>this.map_.getInteractions().remove(e),this.map_.getOverlayContainer().classList.remove("olcs-hideoverlay"),this.map_.getOverlayContainerStopEvent().classList.remove("olcs-hideoverlay"),this.hiddenRootGroup_&&(this.hiddenRootGroup_.setVisible(!0),this.hiddenRootGroup_=null)),this.camera_.updateView()}warmUp(e,t){if(this.enabled_)return;this.throwOnUnitializedMap_(),this.camera_.readFromView();const i=this.globe_.ellipsoid,n=this.scene_.camera,s=i.cartesianToCartographic(n.position);s.height<e&&(s.height=e,n.position=i.cartographicToCartesian(s)),this.warmingUp_=!0,this.render_(),setTimeout(()=>{this.warmingUp_=!1},t)}setBlockCesiumRendering(e){this.blockCesiumRendering_!==e&&(this.blockCesiumRendering_=e,this.render_())}enableAutoRenderLoop(){this.autoRenderLoop_||(this.autoRenderLoop_=new E(this))}getAutoRenderLoop(){return this.autoRenderLoop_}setResolutionScale(e){(e=Math.max(0,e))!==this.resolutionScale_&&(this.resolutionScale_=Math.max(0,e),this.resolutionScaleChanged_=!0,this.autoRenderLoop_&&this.autoRenderLoop_.restartRenderLoop())}setTargetFrameRate(e){this.targetFrameRate_!==e&&(this.targetFrameRate_=e,this.render_())}throwOnUnitializedMap_(){const e=this.map_.getView(),t=e.getCenter();if(!e.isDef()||isNaN(t[0])||isNaN(t[1]))throw new Error(`The OpenLayers map is not properly initialized: ${t} / ${e.getResolution()}`)}}Object.defineProperties(oe.prototype,{trackedFeature:{get:function(){return this.trackedFeature_},set:function(e){if(this.trackedFeature_!==e){const t=this.scene_;if(!e||!e.getGeometry())return this.needTrackedEntityUpdate_=!1,t.screenSpaceCameraController.enableTilt=!0,this.trackedEntity_&&this.dataSourceDisplay_.defaultDataSource.entities.remove(this.trackedEntity_),this.trackedEntity_=null,this.trackedFeature_=null,this.entityView_=null,void t.camera.lookAtTransform(Cesium.Matrix4.IDENTITY);this.trackedFeature_=e,this.needTrackedEntityUpdate_=!0;const i=this.to4326Transform_,n=function(){const t=e.getGeometry().getCoordinates(),n=i(t,void 0,t.length);return R.ol4326CoordinateToCesiumCartesian(n)},s={position:new Cesium.CallbackProperty((e,t)=>n(),!1),point:{pixelSize:1,color:Cesium.Color.TRANSPARENT}};this.trackedEntity_=this.dataSourceDisplay_.defaultDataSource.entities.add(s)}}}});var ae=oe;var le=class{constructor(e){this.promise,this.url_=e}load(){return this.promise||(this.promise=new Promise((e,t)=>{const i=document.createElement("script");i.onload=()=>e(),i.onerror=()=>t(),document.head.appendChild(i),i.src=this.url_})),this.promise}};var ce=class extends x.a{constructor(e,{map:t,cameraExtentInRadians:i}={}){super(),this.cesiumUrl_=e,this.map=t,this.cameraExtentInRadians=i||null,this.boundingSphere_,this.blockLimiter_=!1,this.promise_,this.ol3d,this.cesiumInitialTilt_=G(50),this.fogDensity=1e-4,this.fogSSEFactor=25,this.minimumZoomDistance=2,this.maximumZoomDistance=1e7,this.limitCameraToBoundingSphereRatio=e=>e>3e3?9:3}load(){if(!this.promise_){const e=new le(this.cesiumUrl_);this.promise_=e.load().then(()=>this.onCesiumLoaded())}return this.promise_}onCesiumLoaded(){if(this.cameraExtentInRadians){const e=new Cesium.Rectangle(...this.cameraExtentInRadians);Cesium.Camera.DEFAULT_VIEW_RECTANGLE=e,this.boundingSphere_=Cesium.BoundingSphere.fromRectangle3D(e,Cesium.Ellipsoid.WGS84,300)}this.ol3d=this.instantiateOLCesium();const e=this.ol3d.getCesiumScene();return this.configureForUsability(e),this.configureForPerformance(e),this.dispatchEvent("load"),this.ol3d}instantiateOLCesium(){const e=new ae({map:this.map}),t=e.getCesiumScene(),i=Cesium.createWorldTerrain();return t.terrainProvider=i,e}configureForPerformance(e){const t=e.fog;t.enabled=!0,t.density=this.fogDensity,t.screenSpaceErrorFactor=this.fogSSEFactor}configureForUsability(e){const t=e.screenSpaceCameraController;t.minimumZoomDistance=this.minimumZoomDistance,t.maximumZoomDistance=this.maximumZoomDistance,e.globe.depthTestAgainstTerrain=!0,e.globe.baseColor=Cesium.Color.WHITE,e.backgroundColor=Cesium.Color.WHITE,this.boundingSphere_&&e.postRender.addEventListener(this.limitCameraToBoundingSphere.bind(this),e),this.ol3d.enableAutoRenderLoop()}limitCameraToBoundingSphere(){if(this.boundingSphere_&&!this.blockLimiter_){const e=this.ol3d.getCesiumScene().camera,t=e.position,i=Cesium.Cartographic.fromCartesian(t),n=this.limitCameraToBoundingSphereRatio(i.height);if(Cesium.Cartesian3.distance(this.boundingSphere_.center,t)>this.boundingSphere_.radius*n){if(!0===e.flying)return;{this.blockLimiter_=!0;const t=()=>this.blockLimiter_=!1;e.flyToBoundingSphere(this.boundingSphere_,{complete:t,cancel:t})}}}}toggle3d(){return this.load().then(e=>{const t=e.getEnabled(),i=e.getCesiumScene();return t?R.resetToNorthZenith(this.map,i).then(()=>{e.setEnabled(!1),this.dispatchEvent("toggle")}):(e.setEnabled(!0),this.dispatchEvent("toggle"),R.rotateAroundBottomCenter(i,this.cesiumInitialTilt_))})}set3dWithView(e,t,i,n,s){return this.load().then(r=>{const o=r.getEnabled(),a=r.getCesiumScene().camera,l=Cesium.Cartesian3.fromDegrees(e,t,i),c={heading:Cesium.Math.toRadians(n),pitch:Cesium.Math.toRadians(s),roll:0};o||(r.setEnabled(!0),this.dispatchEvent("toggle")),a.setView({destination:l,orientation:c})})}is3dEnabled(){return!!this.ol3d&&this.ol3d.getEnabled()}getHeading(){return this.map&&this.map.getView().getRotation()||0}getTiltOnGlobe(){const e=this.ol3d.getCesiumScene();return-R.computeSignedTiltAngleOnGlobe(e)}setHeading(e){const t=this.ol3d.getCesiumScene(),i=R.pickBottomPoint(t);i&&R.setHeadingUsingBottomCenter(t,e,i)}getOl3d(){return this.ol3d}getOlView(){return this.map.getView()}getCesiumViewMatrix(){return this.ol3d.getCesiumScene().camera.viewMatrix}getCesiumScene(){return this.ol3d.getCesiumScene()}flyToRectangle(e,t=0){const i=this.getCesiumScene().camera,n=i.getRectangleCameraCoordinates(e),s=Cesium.Cartesian3.magnitude(n)+t;return Cesium.Cartesian3.normalize(n,n),Cesium.Cartesian3.multiplyByScalar(n,s,n),new Promise((e,t)=>{this.cameraExtentInRadians?i.flyTo({destination:n,complete:()=>e(),cancel:()=>t(),endTransform:Cesium.Matrix4.IDENTITY}):t()})}getCameraExtentRectangle(){if(this.cameraExtentInRadians)return new Cesium.Rectangle(...this.cameraExtentInRadians)}},ue=(t.default=ae,window.olcs={});ue.OLCesium=ae,ue.AbstractSynchronizer=V,ue.RasterSynchronizer=j,ue.VectorSynchronizer=te,ue.core=R,ue.core.OLImageryProvider=L,ue.core.VectorLayerCounterpart=J,ue.contrib={},ue.contrib.LazyLoader=le,ue.contrib.Manager=ce}]);
//# sourceMappingURL=olcesium.js.map